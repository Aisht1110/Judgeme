<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FriendshipMeter • Bond Test</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    /* --- NEW ADDITIONS FOR MOBILE UX --- */
    html {
      -webkit-text-size-adjust: 100%; /* Prevent iOS text size adjust on landscape */
      -moz-text-size-adjust: 100%;    /* Prevent Firefox text size adjust */
      text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    }
    /* --- END NEW ADDITIONS --- */

    body {
      font-family: 'Montserrat', ui-sans-serif, system-ui, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.10), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,211,238,0.12), transparent 60%),
        linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #8b5cf6; }

    /* --- NEW ADDITION FOR MOBILE UX --- */
    button, [role="button"], [data-action] {
      touch-action: manipulation; /* Disables double-tap to zoom delay on mobile */
    }
    /* --- END NEW ADDITION --- */

    @keyframes subtle-pulse { 0%,100%{ box-shadow:0 0 0 0 rgba(109,40,217,.28);} 50%{ box-shadow:0 0 24px 8px rgba(109,40,217,.18);} }
    .glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(18px) saturate(120%); -webkit-backdrop-filter: blur(18px) saturate(120%); border: 1px solid rgba(148,163,184,0.22); }
    .cta {
      position: relative; background-image: linear-gradient(92deg,#6366f1 0%,#22d3ee 100%); color:#fff;
      box-shadow: 0 10px 20px rgba(99,102,241,.35), inset 0 1px 0 rgba(255,255,255,.25);
      transition: transform .2s cubic-bezier(.2,.7,.3,1), box-shadow .2s, filter .2s; isolation:isolate;
    }
    .cta::before{content:""; position:absolute; inset:1px; border-radius:inherit; background: radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,.22), transparent 55%); pointer-events:none; z-index:0;}
    .cta::after{content:""; position:absolute; top:0; left:-140%; width:120%; height:100%; background: linear-gradient(100deg, transparent 40%, rgba(255,255,255,.28) 50%, transparent 60%); transform: skewX(-12deg); transition:left 800ms ease; pointer-events:none; z-index:1;}
    .cta:hover{ transform: translateY(-2px) scale(1.03); box-shadow: 0 16px 30px rgba(99,102,241,.45), inset 0 1px 0 rgba(255,255,255,.28); filter:saturate(110%); }
    .cta:hover::after{ left:140%; }
    .cta:active{ transform: translateY(0) scale(.99); box-shadow: 0 8px 16px rgba(99,102,241,.30); }
    .cta:focus-visible{ outline:none; box-shadow: 0 0 0 4px rgba(34,211,238,.35), 0 12px 24px rgba(99,102,241,.35); }

    .metric{ transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease; }
    .metric:hover{ transform: translateY(-3px); box-shadow:0 10px 22px rgba(15,23,42,.06); border-color: rgba(99,102,241,.25); }

    .progress-sheen{ position:relative; overflow:hidden; }
    .progress-sheen::after{ content:""; position:absolute; top:0; left:-40%; width:40%; height:100%; background:linear-gradient(100deg, transparent 30%, rgba(255,255,255,.35) 50%, transparent 70%); animation: sheen 2.2s infinite ease; }
    @keyframes sheen { 0%{ left:-40%; } 100%{ left:110%; } }

    /* Result upgrades */
    .result-card { background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75)); }
    .gauge {
      --size: 160px; --track: 10; --value: 0; --color: #6366f1;
      width: var(--size); height: var(--size); border-radius: 50%;
      background:
        radial-gradient(farthest-side, white 79%, transparent 80% 100%),
        conic-gradient(var(--color) calc(var(--value)*1%), #e5e7eb 0);
      mask: radial-gradient(farthest-side, transparent calc(100% - var(--track)*1px - 1px), #000 calc(100% - var(--track)*1px));
      position: relative; display:grid; place-items:center;
    }
    .gauge .gauge-content {
      position:absolute; 
      display: flex;
      flex-direction: column;
      align-items: center;
      font-weight: 900;
      color: #111827;
    }
    .stat { background: rgba(255,255,255,.8); border:1px solid rgba(148,163,184,.25); }
    .badge { padding: 6px 10px; border-radius:9999px; color:white; font-weight:700; font-size:.85rem; }

    /* --- NEW MODAL STYLES --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      animation: fadeIn 300ms ease forwards;
    }
    
    .modal-content {
      animation: slideIn 300ms ease 100ms forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    @keyframes slideIn {
      to { opacity: 1; transform: translateY(0); }
    }
    /* --- END MODAL STYLES --- */

    /* --- NEW STAT CARD & ANIMATION STYLES --- */
    .stat-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      transition: transform 250ms ease, box-shadow 250ms ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }
    .stat-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #475569; /* slate-600 */
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 1.75rem; /* 2xl */
      font-weight: 800; /* extrabold */
      color: #1e293b; /* slate-800 */
      line-height: 1;
    }
    .stat-desc {
      font-size: 0.75rem;
      color: #64748b; /* slate-500 */
    }

    /* Page load animations */
    @keyframes resultPopIn {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes resultFadeUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .animate-pop-in { animation: resultPopIn 500ms ease forwards; }
    .animate-fade-up { animation: resultFadeUp 500ms ease forwards; }
    /* --- END STAT CARD & ANIMATION STYLES --- */

  
/* ========== ENHANCED RESULT PAGE STYLES ========== */

/* Smooth entrance animations */
@keyframes slideInScale {
  0% { opacity: 0; transform: translateY(40px) scale(0.95); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes fadeInUp {
  0% { opacity: 0; transform: translateY(25px); }
  100% { opacity: 1; transform: translateY(0); }
}

@keyframes bounceIn {
  0% { opacity: 0; transform: scale(0.3); }
  50% { opacity: 1; transform: scale(1.08); }
  70% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

@keyframes floatBadge {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

@keyframes pulseGlow {
  0%, 100% { 
    box-shadow: 0 0 30px rgba(99,102,241,0.4),
                0 0 60px rgba(99,102,241,0.2); 
  }
  50% { 
    box-shadow: 0 0 50px rgba(99,102,241,0.6),
                0 0 80px rgba(99,102,241,0.3); 
  }
}

@keyframes confettiFall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Enhanced result card */
.result-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.92)) !important;
  animation: slideInScale 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
}

/* Improved gauge with progress ring */
.gauge-enhanced {
  position: relative;
  width: 240px;
  height: 240px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
  box-shadow: 
    0 25px 50px rgba(0,0,0,0.12),
    inset 0 -3px 15px rgba(0,0,0,0.05),
    inset 0 3px 15px rgba(255,255,255,0.9);
  animation: bounceIn 0.9s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.gauge-enhanced::before {
  content: '';
  position: absolute;
  inset: -20px;
  border-radius: 50%;
  /* Conic gradient now uses full 360 degrees based on score 0-100 */
  background: conic-gradient(
    from -90deg,
    var(--color, #6366f1) 0%,
    var(--color, #6366f1) calc(var(--value, 0) * 3.6deg), /* 100 points = 360 degrees */
    rgba(226,232,240,0.4) calc(var(--value, 0) * 3.6deg),
    rgba(226,232,240,0.4) 360deg
  );
  mask: radial-gradient(closest-side, transparent 86%, white 87%);
  -webkit-mask: radial-gradient(closest-side, transparent 86%, white 87%);
  animation: pulseGlow 3s ease-in-out infinite;
}

.gauge-enhanced::after {
  content: '';
  position: absolute;
  inset: -22px;
  border-radius: 50%;
  background: inherit;
  filter: blur(20px);
  opacity: 0.3;
  z-index: -1;
}

.gauge-content-enhanced {
  text-align: center;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.score-number-enhanced {
  font-size: 4rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--color, #6366f1), var(--color-dark, #4f46e5));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -3px;
  line-height: 1;
  text-shadow: 0 2px 10px rgba(99,102,241,0.2);
}

.emoji-icon-enhanced {
  font-size: 3.5rem;
  animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.4s forwards;
  opacity: 0;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}

.score-label {
  font-size: 0.75rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

/* Enhanced badge with shimmer */
.badge-enhanced {
  padding: 14px 32px;
  border-radius: 50px;
  color: white;
  font-weight: 800;
  font-size: 1.25rem;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  box-shadow: 
    0 12px 30px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.35),
    inset 0 -1px 0 rgba(0,0,0,0.2);
  animation: floatBadge 3.5s ease-in-out infinite;
  position: relative;
  overflow: hidden;
}

.badge-enhanced::before {
  content: '';
  position: absolute;
  top: 0;
  left: -150%;
  width: 150%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: shimmer 3s infinite;
}

/* Profile section improvements */
.profile-section-enhanced {
  animation: fadeInUp 0.7s ease-out 0.4s forwards;
  opacity: 0;
}

.profile-title-enhanced {
  font-size: 2.75rem;
  font-weight: 900;
  background: linear-gradient(135deg, #1e293b, #475569);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1.25rem;
  line-height: 1.1;
}

.profile-description-enhanced {
  font-size: 1.125rem;
  line-height: 1.9;
  color: #334155;
  margin-top: 1.5rem;
  padding: 1.75rem;
  background: linear-gradient(135deg, rgba(248,250,252,0.9), rgba(241,245,249,0.8));
  border-radius: 18px;
  border-left: 5px solid var(--color, #6366f1);
  box-shadow: 0 4px 15px rgba(0,0,0,0.04);
  backdrop-filter: blur(10px);
  /* Use white-space to preserve newlines from the JS report */
  white-space: pre-wrap;
}

/* Button styles */
.btn-enhanced {
  padding: 15px 30px;
  border-radius: 16px;
  font-weight: 700;
  font-size: 1rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: none;
  cursor: pointer;
}

.btn-enhanced:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.btn-enhanced:active {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-gradient-enhanced {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
}

.btn-gradient-enhanced::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, #8b5cf6, #a78bfa);
  opacity: 0;
  transition: opacity 0.3s;
}

.btn-gradient-enhanced:hover::before {
  opacity: 1;
}

.btn-gradient-enhanced span {
  position: relative;
  z-index: 1;
}

.btn-outline-enhanced {
  background: white;
  color: #475569;
  border: 2.5px solid #e2e8f0;
}

.btn-outline-enhanced:hover {
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-color: #cbd5e1;
}

.btn-success-enhanced {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.btn-success-enhanced:hover {
  background: linear-gradient(135deg, #059669, #047857);
}

/* Stats cards improvement */
.stats-grid-enhanced {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 24px;
  margin-top: 3.5rem;
  animation: fadeInUp 0.7s ease-out 0.8s forwards;
  opacity: 0;
}

.stat-card-enhanced {
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(249,250,251,0.9));
  padding: 28px;
  border-radius: 24px;
  text-align: center;
  border: 2px solid rgba(148,163,184,0.15);
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card-enhanced::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--color, #6366f1), var(--color-dark, #4f46e5));
  transform: scaleX(0);
  transition: transform 0.4s;
}

.stat-card-enhanced:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.12);
  border-color: var(--color, #6366f1);
}

.stat-card-enhanced:hover::before {
  transform: scaleX(1);
}

.stat-value-enhanced {
  font-size: 3rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--color, #6366f1), var(--color-dark, #4f46e5));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1;
  margin: 12px 0;
}

.stat-title-enhanced {
  font-size: 0.875rem;
  color: #64748b;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.2px;
}

.stat-desc-enhanced {
  font-size: 0.875rem;
  color: #94a3b8;
  margin-top: 8px;
  line-height: 1.5;
}

/* Toast notification */
.toast-notification {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 18px 28px;
  border-radius: 16px;
  box-shadow: 0 12px 35px rgba(16,185,129,0.5);
  font-weight: 700;
  font-size: 1rem;
  z-index: 10000;
  animation: slideInScale 0.5s ease-out forwards;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Confetti */
.confetti {
  position: fixed;
  width: 12px;
  height: 12px;
  border-radius: 2px;
  animation: confettiFall 3s linear forwards;
  pointer-events: none;
  z-index: 9999;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .gauge-enhanced {
    width: 200px;
    height: 200px;
  }

  .score-number-enhanced {
    font-size: 3rem;
  }

  .emoji-icon-enhanced {
    font-size: 2.5rem;
  }

  .profile-title-enhanced {
    font-size: 2rem;
  }

  .btn-enhanced {
    width: 100%;
    justify-content: center;
  }

  .stats-grid-enhanced {
    grid-template-columns: 1fr;
  }
}

/* ========== UI/UX ENHANCEMENTS ========== */

/* Improved navigation */
.nav-item {
  position: relative;
  transition: color 0.2s ease;
}

.nav-item::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 0;
  height: 2px;
  background: linear-gradient(90deg, #6366f1, #22d3ee);
  transition: width 0.3s ease;
}

.nav-item:hover::after {
  width: 100%;
}

/* Enhanced quiz options */
.quiz-option {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.quiz-option::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99,102,241,0.1), transparent);
  transition: left 0.5s ease;
}

.quiz-option:hover::before {
  left: 100%;
}

/* Improved progress bar */
.progress-container {
  position: relative;
  overflow: hidden;
}

.progress-fill {
  position: relative;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Enhanced home page cards */
.feature-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.feature-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #6366f1, #22d3ee);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.feature-card:hover::before {
  transform: scaleX(1);
}

/* Improved focus states */
.focus-enhanced:focus {
  outline: 2px solid #6366f1;
  outline-offset: 2px;
}

/* Loading animation improvements */
.loading-dots {
  display: inline-flex;
  gap: 4px;
}

.loading-dots div {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #6366f1;
  animation: pulse 1.5s ease-in-out infinite both;
}

.loading-dots div:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-dots div:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes pulse {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

/* Improved mobile experience */
@media (max-width: 640px) {
  .mobile-optimized {
    padding: 1rem;
  }
  
  .mobile-stack {
    flex-direction: column;
  }
  
  .mobile-full {
    width: 100%;
  }
}

/* Enhanced accessibility */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Improved button states */
.btn-enhanced:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
}

.btn-enhanced:disabled:hover {
  transform: none !important;
  box-shadow: 0 6px 15px rgba(0,0,0,0.15) !important;
}

/* Enhanced transitions */
.smooth-transition {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Improved text readability */
.text-readable {
  line-height: 1.7;
  letter-spacing: 0.01em;
}

/* Enhanced visual hierarchy */
.visual-hierarchy h1 {
  font-weight: 900;
  line-height: 1.1;
}

.visual-hierarchy h2 {
  font-weight: 800;
  line-height: 1.2;
}

.visual-hierarchy h3 {
  font-weight: 700;
  line-height: 1.3;
}

/* Improved form elements */
.form-enhanced {
  transition: all 0.2s ease;
}

.form-enhanced:focus {
  box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
  border-color: #6366f1;
}

/* Enhanced error states */
.error-state {
  border-color: #ef4444;
  background-color: rgba(239,68,68,0.05);
}

.error-message {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* Success states */
.success-state {
  border-color: #10b981;
  background-color: rgba(16,185,129,0.05);
}

.success-message {
  color: #10b981;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* Improved spacing system */
.spacing-sm { margin-bottom: 0.5rem; }
.spacing-md { margin-bottom: 1rem; }
.spacing-lg { margin-bottom: 1.5rem; }
.spacing-xl { margin-bottom: 2rem; }

/* Enhanced color system */
.color-primary { color: #6366f1; }
.color-secondary { color: #8b5cf6; }
.color-accent { color: #22d3ee; }
.color-success { color: #10b981; }
.color-warning { color: #f59e0b; }
.color-error { color: #ef4444; }

/* Improved typography scale */
.text-xs { font-size: 0.75rem; }
.text-sm { font-size: 0.875rem; }
.text-base { font-size: 1rem; }
.text-lg { font-size: 1.125rem; }
.text-xl { font-size: 1.25rem; }
.text-2xl { font-size: 1.5rem; }
.text-3xl { font-size: 1.875rem; }
.text-4xl { font-size: 2.25rem; }
.text-5xl { font-size: 3rem; }
.text-6xl { font-size: 3.75rem; }

/* Enhanced shadows */
.shadow-subtle { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.shadow-medium { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.shadow-large { box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
.shadow-xl { box-shadow: 0 20px 25px rgba(0,0,0,0.1); }

/* Improved border radius system */
.rounded-sm { border-radius: 0.25rem; }
.rounded-md { border-radius: 0.375rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-xl { border-radius: 0.75rem; }
.rounded-2xl { border-radius: 1rem; }
.rounded-3xl { border-radius: 1.5rem; }

/* Enhanced z-index system */
.z-dropdown { z-index: 1000; }
.z-sticky { z-index: 1020; }
.z-fixed { z-index: 1030; }
.z-modal { z-index: 1040; }
.z-popover { z-index: 1050; }
.z-tooltip { z-index: 1060; }

/* Improved animations */
.animate-fade-in {
  animation: fadeIn 0.5s ease-out;
}

.animate-slide-up {
  animation: slideUp 0.5s ease-out;
}

.animate-slide-down {
  animation: slideDown 0.5s ease-out;
}

.animate-scale-in {
  animation: scaleIn 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Enhanced focus management */
.focus-trap {
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.focus-trap:focus {
  outline: 2px solid #6366f1;
  outline-offset: 2px;
}

/* Improved color contrast for accessibility */
.high-contrast {
  color: #1f2937;
}

.high-contrast-bg {
  background-color: #f8fafc;
}

/* Enhanced touch targets for mobile */
.touch-target {
  min-height: 44px;
  min-width: 44px;
}

/* Improved selection states */
::selection {
  background-color: rgba(99,102,241,0.2);
}

::-moz-selection {
  background-color: rgba(99,102,241,0.2);
}

/* Enhanced loading states */
.loading-state {
  position: relative;
  overflow: hidden;
}

.loading-state::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  transform: translateX(-100%);
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,0.4),
    transparent
  );
  animation: shimmer 1.5s infinite;
}

/* Improved image handling */
.image-responsive {
  max-width: 100%;
  height: auto;
}

.image-cover {
  object-fit: cover;
  width: 100%;
  height: 100%;
}

/* Enhanced grid system */
.grid-responsive {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

/* Improved container queries simulation */
.container-adaptive {
  width: 100%;
  margin-left: auto;
  margin-right: auto;
}

@media (min-width: 640px) {
  .container-adaptive {
    max-width: 640px;
  }
}

@media (min-width: 768px) {
  .container-adaptive {
    max-width: 768px;
  }
}

@media (min-width: 1024px) {
  .container-adaptive {
    max-width: 1024px;
  }
}

@media (min-width: 1280px) {
  .container-adaptive {
    max-width: 1280px;
  }
}

/* Enhanced utility classes */
.flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.text-balance {
  text-wrap: balance;
}

.text-pretty {
  text-wrap: pretty;
}

/* Improved dark mode support (if needed in future) */
@media (prefers-color-scheme: dark) {
  .dark-mode-support {
    background-color: #1f2937;
    color: #f9fafb;
  }
}

/* Enhanced print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .print-optimized {
    background: white !important;
    color: black !imptant;
  }
}

/* Improved performance optimizations */
.will-change-transform {
  will-change: transform;
}

.will-change-opacity {
  will-change: opacity;
}

/* Enhanced error boundaries */
.error-boundary {
  padding: 2rem;
  text-align: center;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 0.5rem;
}

/* Improved empty states */
.empty-state {
  padding: 3rem 1rem;
  text-align: center;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

/* Enhanced tooltips */
.tooltip {
  position: relative;
}

.tooltip::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 0.5rem 0.75rem;
  background: #1f2937;
  color: white;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 1060;
}

.tooltip:hover::before {
  opacity: 1;
}

/* Improved accessibility for reduced motion */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
  </style>
</head>
<body class="min-h-screen antialiased">

  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur-sm shadow-md">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
      <div class="text-2xl font-extrabold text-gray-900">
        Friendship<span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-blue-500">Meter</span>
      </div>
      <div class="flex items-center gap-3">
        <button id="nav-home" class="nav-item text-sm text-gray-700 hover:text-gray-900 focus-enhanced">Home</button>
        <button id="nav-about" class="nav-item text-sm text-gray-700 hover:text-gray-900 focus-enhanced">About</button>
      </div>
    </nav>
  </header>

  <main id="app" class="max-w-6xl mx-auto p-6 md:p-10"></main>

  <div id="pledge-modal" class="modal-overlay hidden">
    <div class="modal-content glass-card rounded-3xl shadow-2xl p-8 md:p-10 max-w-md w-full text-center">
      <div class="text-6xl mb-4">🤝</div>
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">An Honest Start</h2>
      <p class="text-lg text-slate-700 mb-8">
        "I will answer honestly about my friendship."
      </p>
      <button type="button" data-action="accept-pledge" class="cta inline-flex items-center justify-center px-10 py-3 rounded-full font-extrabold text-lg tracking-wide uppercase cursor-pointer select-none focus-enhanced">
        <span class="relative z-10">I Agree</span>
      </button>
    </div>
  </div>
  <script type="module">
    // --- REFACTORED JAVASCRIPT ---

    // App state and router
    const appState = { page: 'home', currentIndex: 0, answers: [], resultData: null, shareId: null };
    const appRoot = document.getElementById('app');

    /**
     * Sets the current page, renders it, and manages focus for accessibility.
     * @param {string} p - The page name to navigate to.
     */
    function setPage(p) {
      appState.page = p;
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Manage focus for accessibility
      setTimeout(() => {
        const firstHeading = appRoot.querySelector('h1, h2');
        if (firstHeading) {
          if (!firstHeading.hasAttribute('tabindex')) {
            firstHeading.setAttribute('tabindex', '-1');
          }
          firstHeading.focus();
        }
      }, 100);
    }

    /**
     * Initializes the application, attaches event listeners, and renders the initial page.
     */
    function initApp() {
      // Attach main listener for all dynamic content
      document.addEventListener('click', handleAppClick);

      // Per-user seed for randomized answers
      window.USER_SEED = getOrCreateUserSeed();

      // Check for shared results in URL
      const params = new URLSearchParams(location.search);
      const share = params.get('share');
      if (share) {
        // NOTE: In a real app, this would fetch from a DB. Using localStorage for this demo.
        const saved = JSON.parse(localStorage.getItem('fm:' + share) || 'null');
        if (saved) {
          appState.resultData = saved;
          appState.shareId = share;
          appState.page = 'result';
        }
      }
      render();
    }

    /**
     * Handles all clicks using event delegation.
     * @param {Event} e - The click event.
     */
    function handleAppClick(e) {
      // Handle static nav clicks
      if (e.target.id === 'nav-home') {
        // Use setPage to go home
        retest(true); // true = go to home
        return;
      }
      if (e.target.id === 'nav-about') {
        setPage('about');
        return;
      }

      const target = e.target.closest('[data-action]');
      if (!target) return;

      const action = target.dataset.action;
      const ds = target.dataset;

      switch (action) {
        case 'start-quiz':
          document.getElementById('pledge-modal').classList.remove('hidden');
          break;
        case 'accept-pledge':
          document.getElementById('pledge-modal').classList.add('hidden');
          setPage('quiz');
          break;
        case 'select-option':
          selectOption(parseInt(ds.questionId, 10), ds.optionId, parseFloat(ds.weight));
          break;
        case 'prev-question':
          prevQuestion();
          break;
        case 'next-question':
          if (!target.disabled) nextQuestion();
          break;
        case 'copy-share':
          copyShare(ds.shareId, target);
          break;
        case 'retest':
          retest();
          break;
        case 'premium-ai':
          handlePremiumAI();
          break;
      }
    }

    // --- Seeded randomization helpers (stable per user) ---
    function getOrCreateUserSeed() {
      const key = 'fm:user-seed'; // Changed key for new app
      let seed = localStorage.getItem(key);
      if (!seed) {
        seed = Math.random().toString(36).slice(2, 10);
        localStorage.setItem(key, seed);
      }
      return seed;
    }
    function mulberry32(a) { return function () { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
    function strHash(s) { let h = 2166136261 >>> 0; for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); } return h >>> 0; }
    function seededShuffle(arr, seedStr) {
      const rnd = mulberry32(strHash(seedStr));
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // --- NEW: 20-question friendship bank ---
    const QUESTIONS = [
      { id: 1, text: "How emotionally safe do you feel being your true self around your friend?",
        options: [
          { id: "a", label: "Completely safe and accepted", weight: 5 },
          { id: "b", label: "Mostly safe, minor hesitation", weight: 4 },
          { id: "c", label: "Sometimes unsure", weight: 3 },
          { id: "d", label: "Often guarded", weight: 2 },
          { id: "e", label: "I hide most of myself", weight: 1 }
        ]
      },
      { id: 2, text: "When you feel emotionally low, how likely is your friend to offer genuine comfort or support?",
        options: [
          { id: "a", label: "Always, without me even asking", weight: 5 },
          { id: "b", label: "Usually when I express it", weight: 4 },
          { id: "c", label: "Only if I directly ask", weight: 3 },
          { id: "d", label: "Rarely supportive", weight: 2 },
          { id: "e", label: "Dismissive or uncomfortable with emotions", weight: 1 }
        ]
      },
      { id: 3, text: "How often do your conversations go beyond surface-level topics?",
        options: [
          { id: "a", label: "Very often, we talk about deep personal stuff", weight: 5 },
          { id: "b", label: "Often, with a mix of light and deep talks", weight: 4 },
          { id: "c", label: "Sometimes, but not much", weight: 3 },
          { id: "d", label: "Rarely, it stays casual", weight: 2 },
          { id: "e", label: "Never, only superficial things", weight: 1 }
        ]
      },
      { id: 4, text: "When conflict arises, how is it usually handled between you both?",
        options: [
          { id: "a", label: "Calm talk, both sides listen & resolve", weight: 5 },
          { id: "b", label: "One of us takes initiative later", weight: 4 },
          { id: "c", label: "Avoided but eventually forgotten", weight: 3 },
          { id: "d", label: "Usually turns into argument or distance", weight: 2 },
          { id: "e", label: "No resolution, leads to resentment", weight: 1 }
        ]
      },
      { id: 5, text: "How much reciprocity exists — do you both give and take equally?",
        options: [
          { id: "a", label: "Perfectly balanced", weight: 5 },
          { id: "b", label: "Slightly more from one side, but fair", weight: 4 },
          { id: "c", label: "Uneven often", weight: 3 },
          { id: "d", label: "Mostly one-sided", weight: 2 },
          { id: "e", label: "I feel drained by giving more", weight: 1 }
        ]
      },
      { id: 6, text: "How often does your friend genuinely celebrate your successes without envy?",
        options: [
          { id: "a", label: "Always with pure happiness", weight: 5 },
          { id: "b", label: "Mostly yes, sometimes quiet", weight: 4 },
          { id: "c", label: "Neutral", weight: 3 },
          { id: "d", label: "Sometimes seems jealous", weight: 2 },
          { id: "e", label: "Often competitive or dismissive", weight: 1 }
        ]
      },
      { id: 7, text: "If you express vulnerability or weakness, how do they usually respond?",
        options: [
          { id: "a", label: "With empathy, warmth, and no judgment", weight: 5 },
          { id: "b", label: "With care, though a bit awkward", weight: 4 },
          { id: "c", label: "They listen but change the topic", weight: 3 },
          { id: "d", label: "They act uncomfortable", weight: 2 },
          { id: "e", label: "They mock or downplay it", weight: 1 }
        ]
      },
      { id: 8, text: "How predictable and consistent is their behavior toward you?",
        options: [
          { id: "a", label: "Consistently kind and stable", weight: 5 },
          { id: "b", label: "Mostly predictable", weight: 4 },
          { id: "c", label: "Sometimes inconsistent", weight: 3 },
          { id: "d", label: "Often unpredictable", weight: 2 },
          { id: "e", label: "Unreliable or erratic", weight: 1 }
        ]
      },
      { id: 9, text: "Do you feel mentally refreshed or drained after spending time together?",
        options: [
          { id: "a", label: "Always refreshed and uplifted", weight: 5 },
          { id: "b", label: "Usually positive", weight: 4 },
          { id: "c", label: "Neutral, depends on the day", weight: 3 },
          { id: "d", label: "Sometimes drained", weight: 2 },
          { id: "e", label: "Frequently emotionally exhausted", weight: 1 }
        ]
      },
      { id: 10, text: "How well do you both handle silence or nonverbal moments?",
        options: [
          { id: "a", label: "Comfortable silence feels natural", weight: 5 },
          { id: "b", label: "Mostly fine", weight: 4 },
          { id: "c", label: "Slightly awkward", weight: 3 },
          { id: "d", label: "Usually uncomfortable", weight: 2 },
          { id: "e", label: "Silence feels like distance", weight: 1 }
        ]
      },
      { id: 11, text: "How often do you initiate versus them?",
        options: [
          { id: "a", label: "Both initiate equally", weight: 5 },
          { id: "b", label: "I do slightly more", weight: 4 },
          { id: "c", label: "Mostly me initiating", weight: 3 },
          { id: "d", label: "Rarely them", weight: 2 },
          { id: "e", label: "Only me, they don't reach out", weight: 1 }
        ]
      },
      { id: 12, text: "If you needed urgent help, would they show up?",
        options: [
          { id: "a", label: "Definitely, no hesitation", weight: 5 },
          { id: "b", label: "Likely, but might delay", weight: 4 },
          { id: "c", label: "Unsure", weight: 3 },
          { id: "d", label: "Probably not", weight: 2 },
          { id: "e", label: "Definitely not", weight: 1 }
        ]
      },
      { id: 13, text: "How often do you feel emotionally understood by them?",
        options: [
          { id: "a", label: "Deeply understood without words", weight: 5 },
          { id: "b", label: "Usually yes", weight: 4 },
          { id: "c", label: "Sometimes", weight: 3 },
          { id: "d", label: "Rarely", weight: 2 },
          { id: "e", label: "Never really", weight: 1 }
        ]
      },
      { id: 14, text: "How much do you share core values or life perspectives?",
        options: [
          { id: "a", label: "Very aligned", weight: 5 },
          { id: "b", label: "Mostly similar", weight: 4 },
          { id: "c", label: "Some overlap, some conflict", weight: 3 },
          { id: "d", label: "Quite different", weight: 2 },
          { id: "e", label: "Opposite beliefs", weight: 1 }
        ]
      },
      { id: 15, text: "How often do they express gratitude or appreciation for your friendship?",
        options: [
          { id: "a", label: "Regularly and sincerely", weight: 5 },
          { id: "b", label: "Occasionally", weight: 4 },
          { id: "c", label: "Rarely", weight: 3 },
          { id: "d", label: "Almost never", weight: 2 },
          { id: "e", label: "Never acknowledged", weight: 1 }
        ]
      },
      { id: 16, text: "When you disagree, how respectful is the communication?",
        options: [
          { id: "a", label: "Always respectful, even when firm", weight: 5 },
          { id: "b", label: "Usually calm", weight: 4 },
          { id: "c", label: "Sometimes snappy", weight: 3 },
          { id: "d", label: "Often disrespectful", weight: 2 },
          { id: "e", label: "Disrespectful or dismissive", weight: 1 }
        ]
      },
      { id: 17, text: "How well do they remember things important to you (dates, events, preferences)?",
        options: [
          { id: "a", label: "Extremely attentive", weight: 5 },
          { id: "b", label: "Often remembers", weight: 4 },
          { id: "c", label: "Sometimes", weight: 3 },
          { id: "d", label: "Rarely", weight: 2 },
          { id: "e", label: "Never", weight: 1 }
        ]
      },
      { id: 18, text: "Do they support your growth and self-improvement?",
        options: [
          { id: "a", label: "Actively encourage and push me forward", weight: 5 },
          { id: "b", label: "Supportive when I share goals", weight: 4 },
          { id: "c", label: "Neutral", weight: 3 },
          { id: "d", label: "Sometimes discourage or dismiss", weight: 2 },
          { id: "e", label: "Actively negative or jealous", weight: 1 }
        ]
      },
      { id: 19, text: "How secure do you feel that the friendship will last long-term?",
        options: [
          { id: "a", label: "Very secure and steady", weight: 5 },
          { id: "b", label: "Likely long-term", weight: 4 },
          { id: "c", label: "Unsure", weight: 3 },
          { id: "d", label: "Feels unstable", weight: 2 },
          { id: "e", label: "Likely to fade soon", weight: 1 }
        ]
      },
      { id: 20, text: "How much do you feel your friend respects your boundaries (time, space, opinions)?",
        options: [
          { id: "a", label: "Fully respects them", weight: 5 },
          { id: "b", label: "Mostly respectful", weight: 4 },
          { id: "c", label: "Occasionally crosses them", weight: 3 },
          { id: "d", label: "Often ignores them", weight: 2 },
          { id: "e", label: "Never respects them", weight: 1 }
        ]
      }
    ];

    // --- NEW: Buckets and insights ---
    const FRIENDSHIP_TYPES = [
      { name: 'Secure & Deep Bond', emoji: '💎', min: 85, max: 100 },
      { name: 'Strong but Imperfect', emoji: '🌿', min: 70, max: 84 },
      { name: 'Moderate / Conditional', emoji: '🌀', min: 55, max: 69 },
      { name: 'Strained / Unequal', emoji: '⚠️', min: 35, max: 54 },
      { name: 'Emotionally Unhealthy', emoji: '🚫', min: 20, max: 34 }
    ];
    
    // Use the new score (20-100) to find the type
    function typeFromScore(score) { 
      const t = FRIENDSHIP_TYPES.find(t => score >= t.min && score <= t.max); 
      return t ? t : { name: 'Moderate / Conditional', emoji: '🌀' }; // Default fallback
    }

    // Simplified insights based on user prompt
    const FRIENDSHIP_INSIGHTS = {
      'Secure & Deep Bond': "High trust, empathy, reciprocity, and emotional safety. This is a rare and valuable connection.",
      'Strong but Imperfect': "Good stability and trust, with some minor value or effort gaps. A solid foundation to build on.",
      'Moderate / Conditional': "Friendship functions but may lack depth, consistency, or balance. Communication is key.",
      'Strained / Unequal': "Clear signs of imbalance, low trust, or weak empathy. May feel one-sided or inconsistent.",
      'Emotionally Unhealthy': "One-sided, emotionally draining, or unreliable. This bond may be costing you peace."
    };

    // --- Simplified report builder ---
    function buildReport(score, type) {
      const core = FRIENDSHIP_INSIGHTS[type] || "Your friendship is unique. Keep communicating honestly.";
      return `${core}`; // Just return the core insight
    }

    // --- Render root ---
    function render() {
      if (appState.page === 'home') appRoot.innerHTML = renderHomePage();
      else if (appState.page === 'quiz') appRoot.innerHTML = renderQuizPage();
      else if (appState.page === 'loading') appRoot.innerHTML = renderLoadingPage();
      else if (appState.page === 'result') appRoot.innerHTML = renderResultPage();
      else if (appState.page === 'about') appRoot.innerHTML = renderAboutPage();
    }

    // --- Pages (Upgraded with data-actions and ARIA) ---
    function renderHomePage() {
      return `
        <div class="flex flex-col items-center justify-center p-6 text-center">
          <div class="glass-card rounded-3xl shadow-2xl p-8 md:p-14 animate-[subtle-pulse_5s_infinite]">
            <h1 tabindex="-1" class="text-6xl md:text-7xl font-extrabold tracking-tight leading-tight text-gray-900 visual-hierarchy">
              Friendship<span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-blue-500">Meter</span>
            </h1>
            <p class="mt-5 text-lg md:text-xl text-slate-600 max-w-2xl mx-auto text-readable">
              Discover the strength of your friendship bond. Answer 20 psychology-based scenarios to get an instant, private analysis of your connection.
            </p>
            <div class="mt-6 flex flex-col md:flex-row gap-3 md:gap-4 justify-center">
              <div class="px-3 py-2 rounded-full text-sm font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">Psychology-Based</div>
              <div class="px-3 py-2 rounded-full text-sm font-semibold bg-cyan-50 text-cyan-700 border border-cyan-100">Actionable Insights</div>
              <div class="px-3 py-2 rounded-full text-sm font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">100% Private</div>
            </div>
            <div class="my-8 h-px bg-gradient-to-r from-transparent via-indigo-300 to-transparent"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
              <div class="feature-card metric bg-white/70 backdrop-blur rounded-2xl p-5 border border-slate-200">
                <span class="text-purple-600 font-black text-4xl block">20</span>
                <p class="text-sm font-semibold text-purple-700 mt-1">Friendship Scenarios</p>
                <p class="text-xs text-slate-500 mt-1">Based on real social psychology</p>
              </div>
              <div class="feature-card metric bg-white/70 backdrop-blur rounded-2xl p-5 border border-slate-200">
                <span class="text-blue-600 font-black text-4xl block">20–100</span>
                <p class="text-sm font-semibold text-blue-700 mt-1">Bond Score</p>
                <p class="text-xs text-slate-500 mt-1">Raw score, no normalization</p>
              </div>
              <div class="feature-card metric bg-white/70 backdrop-blur rounded-2xl p-5 border border-slate-200">
                <span class="text-slate-700 font-black text-4xl block">5</span>
                <p class="text-sm font-semibold text-slate-700 mt-1">Bond Types</p>
                <p class="text-xs text-slate-500 mt-1">Clear, actionable profiles</p>
              </div>
            </div>
            <div class="flex flex-col items-center gap-3">
              <button type="button" data-action="start-quiz" class="cta inline-flex items-center justify-center px-10 md:px-14 py-4 rounded-full font-extrabold text-lg md:text-2xl tracking-wide uppercase cursor-pointer select-none focus-enhanced touch-target">
                <span class="relative z-10">Start Test</span>
                <svg class="relative z-10 ml-3 h-6 w-6 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M13 5l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path d="M20 12H4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </button>
              <p class="text-xs text-gray-400">Private, client-side scoring. No registration required.</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderQuizPage() {
      const qIndex = appState.currentIndex;
      const q = QUESTIONS[qIndex];
      const progress = Math.round((qIndex / QUESTIONS.length) * 100);
      const selected = appState.answers.find(a => a.questionId === q.id);
      // Seeded shuffle for options
      const options = seededShuffle(q.options, USER_SEED + ':' + q.id);

      return `
        <div class="max-w-3xl mx-auto">
          <div class="glass-card rounded-3xl shadow-2xl p-6 md:p-10">
            <div class="flex items-center justify-between mb-4">
              <div class="text-sm text-gray-600">Question ${qIndex + 1} of ${QUESTIONS.length}</div>
              <div class="w-40">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden progress-container"
                     role="progressbar"
                     aria-valuenow="${progress}"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-label="Quiz progress">
                  <div class="progress-sheen h-full bg-gradient-to-r from-purple-400 to-blue-400 transition-all duration-500 ease-out progress-fill" style="width:${progress}%"></div>
                </div>
              </div>
            </div>

            <h2 tabindex="-1" class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 visual-hierarchy">${q.text}</h2>

            <div class="grid gap-3">
              ${options.map(opt => {
                const isSel = selected && selected.optionId === opt.id;
                const base = "text-left px-4 py-3 rounded-xl border transition quiz-option form-enhanced touch-target";
                const cls = isSel ? "border-indigo-400 bg-indigo-50 text-indigo-900" : "border-gray-200 bg-white text-gray-800 hover:border-indigo-300 hover:bg-indigo-50";
                
                return `
                  <button type="button" 
                          data-action="select-option"
                          data-question-id="${q.id}"
                          data-option-id="${opt.id}"
                          data-weight="${opt.weight}"
                          class="${base} ${cls} focus-enhanced">
                    ${opt.label}
                  </button>
                `;
              }).join('')}
            </div>

            <div class="mt-8 flex justify-between">
              <button data-action="prev-question" class="px-4 py-2 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 focus-enhanced touch-target">Back</button>
              <button data-action="next-question" id="nextBtn" class="px-5 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed focus-enhanced touch-target" ${selected ? "" : "disabled"}>
                ${qIndex === QUESTIONS.length - 1 ? "Finish" : "Next"}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderLoadingPage() {
      return `
        <div class="flex flex-col items-center justify-center py-16">
          <div class="glass-card rounded-3xl shadow-2xl p-10 text-center">
            <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 role="alert" class="text-xl font-semibold text-gray-900">Analyzing your bond...</h3>
            <div class="loading-dots mt-4">
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderResultPage() {
      const result = appState.resultData;
      if (!result) {
        return `<div class="p-6 text-center">No result found. <button data-action="start-quiz" class="text-indigo-600 underline font-semibold hover:text-indigo-800 focus-enhanced">Go Home</button></div>`;
      }

      const shareId = appState.shareId || ensureShareId(result);
      const typeColor = getColorForType(result.type);
      const typeColorDark = getDarkColorForType(result.type);
      const reportText = buildReport(result.score, result.type);
      const typeEmoji = result.emoji;

      // Calculate additional metrics
      // Score is 20-100. Range is 80.
      const percentile = Math.max(0, Math.min(100, Math.round(((result.score - 20) / 80) * 100)));
      // Re-map stats to be based on percentile
      const trust = Math.min(99, Math.max(5, Math.round(percentile * 0.9 + 10)));
      const empathy = Math.min(99, Math.max(5, Math.round(percentile * 1.1 - 5)));
      const reciprocity = Math.min(99, Math.max(5, Math.round(percentile * 0.8 + 15)));

      // Trigger confetti for high scores
      if (result.score >= 85) { // 85 is new top bracket
        setTimeout(() => triggerConfetti(), 600);
      }

      return `
        <div class="max-w-6xl mx-auto">
          <div class="glass-card rounded-3xl shadow-2xl p-6 md:p-12 result-card mb-8">
            <div class="grid md:grid-cols-2 gap-12 items-center">

              <div class="flex flex-col items-center">
                <div class="gauge-enhanced" 
                     style="--value:${result.score}; --color:${typeColor}; --color-dark:${typeColorDark};"
                     role="meter"
                     aria-label="Your bond score"
                     aria-valuenow="${result.score}"
                     aria-valuemin="20"
                     aria-valuemax="100">
                  <div class="gauge-content-enhanced">
                    <div class="emoji-icon-enhanced">${typeEmoji}</div>
                    <div class="score-number-enhanced" style="--color:${typeColor}; --color-dark:${typeColorDark};">${result.score}</div>
                    <div class="score-label">Friendship Score</div>
                  </div>
                </div>
                <div class="badge-enhanced mt-8" style="background:${typeColor};">${result.type}</div>
              </div>

              <div class="profile-section-enhanced">
                <h2 class="profile-title-enhanced visual-hierarchy">🎯 Your Friendship Profile</h2>
                <p class="text-gray-600 text-lg font-medium leading-relaxed text-readable">Congratulations on completing the assessment! Here's your personalized friendship analysis based on your responses.</p>

                <div class="profile-description-enhanced" style="--color:${typeColor};">
                  ${reportText}
                </div>

                <div class="mt-8 flex flex-wrap gap-3">
                  <button data-action="copy-share" data-share-id="${shareId}" class="btn-enhanced btn-gradient-enhanced touch-target focus-enhanced">
                    <span>📤</span>
                    <span>Share Result</span>
                  </button>
                  <button data-action="retest" class="btn-enhanced btn-outline-enhanced touch-target focus-enhanced">
                    <span>🔄</span>
                    <span>Retake Test</span>
                  </button>
                  <button data-action="premium-ai" class="btn-enhanced btn-success-enhanced touch-target focus-enhanced">
                    <span>✨</span>
                    <span>AI Analysis</span>
                  </button>
                </div>

                <p id="ai-premium" class="mt-4 text-sm text-gray-500 hidden" aria-live="polite"></p>
              </div>
            </div>

            <div class="stats-grid-enhanced">
              <div class="stat-card-enhanced" style="--color:${typeColor}; --color-dark:${typeColorDark};">
                <div class="stat-title-enhanced">Overall Score</div>
                <div class="stat-value-enhanced">${result.score}</div>
                <div class="stat-desc-enhanced">Your bond rating (20-100)</div>
              </div>

              <div class="stat-card-enhanced" style="--color:#8b5cf6; --color-dark:#7c3aed;">
                <div class="stat-title-enhanced">Percentile Rank</div>
                <div class="stat-value-enhanced">${percentile}%</div>
                <div class="stat-desc-enhanced">Vs. possible score range</div>
              </div>

              <div class="stat-card-enhanced" style="--color:#10b981; --color-dark:#059669;">
                <div class="stat-title-enhanced">Trust Index</div>
                <div class="stat-value-enhanced">${trust}%</div>
                <div class="stat-desc-enhanced">Consistency & Safety</div>
              </div>

              <div class="stat-card-enhanced" style="--color:#3b82f6; --color-dark:#2563eb;">
                <div class="stat-title-enhanced">Empathy Signal</div>
                <div class="stat-value-enhanced">${empathy}%</div>
                <div class="stat-desc-enhanced">Emotional attunement</div>
              </div>

              <div class="stat-card-enhanced" style="--color:#f59e0b; --color-dark:#d97706;">
                <div class="stat-title-enhanced">Reciprocity Score</div>
                <div class="stat-value-enhanced">${reciprocity}%</div>
                <div class="stat-desc-enhanced">Mutual give & take</div>
              </div>

              <div class="stat-card-enhanced" style="--color:#ec4899; --color-dark:#db2777;">
                <div class="stat-title-enhanced">Completion Rate</div>
                <div class="stat-value-enhanced">100%</div>
                <div class="stat-desc-enhanced">${result.answers?.length || 20} questions answered</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Helper function: Get color for friendship type
    function getColorForType(type) {
      const colors = {
        'Secure & Deep Bond': '#10b981',
        'Strong but Imperfect': '#3b82f6',
        'Moderate / Conditional': '#6366f1',
        'Strained / Unequal': '#f59e0b',
        'Emotionally Unhealthy': '#ef4444'
      };
      return colors[type] || '#8b5cf6';
    }

    // Helper function: Get dark color variant
    function getDarkColorForType(type) {
      const colors = {
        'Secure & Deep Bond': '#059669',
        'Strong but Imperfect': '#2563eb',
        'Moderate / Conditional': '#4f46e5',
        'Strained / Unequal': '#d97706',
        'Emotionally Unhealthy': '#dc2626'
      };
      return colors[type] || '#7c3aed';
    }

    // Confetti animation function
    function triggerConfetti() {
      const colors = ['#6366f1', '#8b5cf6', '#22d3ee', '#10b981', '#f59e0b', '#ec4899'];
      const confettiCount = 60;

      for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = '-20px';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3500);
        }, i * 25);
      }
    }

    // Toast notification function
    function showToast(message, emoji = '✅') {
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `<span style="font-size: 1.5rem;">${emoji}</span><span>${message}</span>`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeInUp 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function renderAboutPage() {
      return `
        <div class="max-w-3xl mx-auto">
          <div class="glass-card rounded-3xl shadow-2xl p-6 md:p-10">
            <h2 tabindex="-1" class="text-2xl font-bold text-gray-900 visual-hierarchy">About FriendshipMeter</h2>
            <p class="text-gray-700 mt-2 text-readable">
              FriendshipMeter maps your choices across 20 psychology-based scenarios to a simple 20–100 score and a clear friendship archetype.
            </p>
            <div class="bg-white/80 backdrop-blur p-6 rounded-2xl shadow-xl border border-gray-100 mt-6">
              <h3 class="text-lg font-semibold text-emerald-600 visual-hierarchy">Privacy & Sourcing</h3>
              <p class="text-gray-700 mt-2 text-readable">
                Your answers are scored locally in your browser and are never sent to a server. If you share a link, only your final score and type are saved to your browser's local storage for the link to work.
              </p>
              <p class="text-gray-700 mt-2 text-readable">
                The questions are based on established psychological constructs in friendship quality, including trust, empathy, reciprocity, and emotional safety.
              </p>
            </div>
          </div>
        </div>
      `;
    }

    // --- Quiz logic ---
    function selectOption(questionId, optionId, weight) {
      const idx = appState.answers.findIndex(a => a.questionId === questionId);
      const entry = { questionId, optionId, weight };
      if (idx >= 0) appState.answers[idx] = entry; else appState.answers.push(entry);
      render(); // refresh highlight and button state
    }
    
    function nextQuestion() {
      const qIndex = appState.currentIndex;
      const q = QUESTIONS[qIndex];
      const answered = appState.answers.some(a => a.questionId === q.id);
      if (!answered) return;

      if (qIndex < QUESTIONS.length - 1) {
        appState.currentIndex++;
        render();
      } else {
        // --- NEW SCORING LOGIC ---
        // Sum the raw weights (1-5). Total score will be 20-100.
        const totalRaw = appState.answers.reduce((sum, a) => sum + a.weight, 0);
        const finalScore = totalRaw; 
        const finalTypeData = typeFromScore(finalScore);
        
        appState.resultData = { 
          score: finalScore, 
          type: finalTypeData.name, 
          emoji: finalTypeData.emoji,
          ts: Date.now(),
          answers: appState.answers // Store answers for 'Completion' card
        };
        // --- END NEW SCORING LOGIC ---
        
        setPage('loading');
        setTimeout(() => setPage('result'), 1200);
      }
    }

    function prevQuestion() {
      if (appState.currentIndex > 0) { appState.currentIndex--; render(); }
      else setPage('home');
    }

    function retest(goHome = false) {
      appState.currentIndex = 0; appState.answers = []; appState.resultData = null; appState.shareId = null;
      history.replaceState(null, '', location.pathname); 
      setPage(goHome ? 'home' : 'quiz');
    }

    // --- Share / persistence ---
    function ensureShareId(resultObj) {
      if (appState.shareId) return appState.shareId;
      const id = Math.random().toString(36).slice(2, 8);
      localStorage.setItem('fm:' + id, JSON.stringify(resultObj)); // Use 'fm:' prefix
      appState.shareId = id; return id;
    }

    function copyShare(id, buttonElement) {
      const url = location.origin + location.pathname + '?share=' + id;
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          showToast('Link copied to clipboard!', '📋');
        }).catch(() => {
          prompt('Copy this link:', url); // Fallback
        });
      } else {
        prompt('Copy this link:', url); // Fallback
      }
    }


    // --- Optional AI premium stub ---
    async function handlePremiumAI() {
      const el = document.getElementById('ai-premium'); if (!el) return;
      el.classList.remove('hidden');
      el.textContent = "Generating deeper insights...";
      
      setTimeout(() => {
        const r = appState.resultData; if (!r) return;
        const insight = FRIENDSHIP_INSIGHTS[r.type] || "Keep communicating honestly.";
        el.textContent = `Personalized analysis for "${r.type}": ${insight}`;
      }, 1200);
    }

    // --- Start the app ---
    window.addEventListener('DOMContentLoaded', initApp);

  </script>
</body>
</html>
